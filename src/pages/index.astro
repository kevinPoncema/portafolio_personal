---
// Importaciones de los componentes
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import Hero from "../components/Hero.astro";
import Skils from "../components/Skils.astro";
import Projects from "../components/Projects.astro";
import Experience from "../components/Experience.astro";
import Formation from "../components/Formation.astro";
import Contact from "../components/Contact.astro";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>KevinPonceDev</title>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BFXW20TRRN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BFXW20TRRN');
</script>
  </head>
  
  <body>
    <div id="app">
      <Header></Header>
      <section id="inicio">
        <Hero />
      </section>
      <section id="habilidades">
        <Skils />
      </section>
      <section id="proyectos">
        <Projects />
      </section>
      <section id="experiencia">
        <Experience />
      </section>
      <section id="formacion">
        <Formation />
      </section>
      <section id="contacto">
        <Contact />
      </section>
      <Footer />
    </div>

    <!-- Modal global de imagen ampliada -->
    <div id="image-modal" class="fixed inset-0 z-[9999] hidden bg-black/90">
      <div class="flex flex-col items-center justify-center min-h-screen p-4">
        <!-- Header del modal con título y botón cerrar -->
        <div class="flex justify-between items-center w-full max-w-4xl mb-4">
          <h3 id="modal-project-title" class="text-white text-xl font-bold"></h3>
          <button 
            id="close-modal"
            class="bg-white/20 hover:bg-white/30 text-white rounded-full p-3 transition-colors duration-200 backdrop-blur-sm"
            aria-label="Cerrar modal"
          >
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Contenedor de imagen con carrusel -->
        <div class="relative max-w-4xl max-h-[70vh] w-full">
          <!-- Imagen principal -->
          <img 
            id="modal-image"
            src=""
            alt=""
            class="w-full h-full object-contain rounded-lg shadow-2xl bg-white/5 backdrop-blur-sm"
          />
          
          <!-- Controles del carrusel en modal -->
          <button 
            id="modal-prev"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all duration-200 hidden backdrop-blur-sm"
            aria-label="Imagen anterior"
          >
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          
          <button 
            id="modal-next"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all duration-200 hidden backdrop-blur-sm"
            aria-label="Imagen siguiente"
          >
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
        
        <!-- Indicadores del modal -->
        <div id="modal-indicators" class="flex justify-center space-x-2 mt-4 hidden">
        </div>
      </div>
    </div>

    <script>
      // Sistema de gestión central de modales
      class ModalManager {
        constructor() {
          this.activeModal = null;
          this.modals = {
            image: {
              element: null,
              closeCallback: null
            },
            project: {
              element: null,
              closeCallback: null
            }
          };
          this.init();
        }

        init() {
          // Inicializar referencias a modales
          this.modals.image.element = document.getElementById('image-modal');
          
          // Event listener global para tecla Escape
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.activeModal) {
              this.closeActive();
            }
          });
        }

        openModal(type, openCallback) {
          // Cerrar cualquier modal activo primero
          this.closeActive();
          
          // Abrir el nuevo modal
          this.activeModal = type;
          if (openCallback) openCallback();
          document.body.style.overflow = 'hidden';
        }

        closeActive() {
          if (!this.activeModal) return;
          
          const modal = this.modals[this.activeModal];
          if (modal.closeCallback) {
            modal.closeCallback();
          }
          
          this.activeModal = null;
          document.body.style.overflow = '';
        }

        registerModal(type, closeCallback) {
          if (this.modals[type]) {
            this.modals[type].closeCallback = closeCallback;
          }
        }

        isActive(type) {
          return this.activeModal === type;
        }
      }

      // Crear instancia global del gestor de modales
      const modalManager = new ModalManager();
      window.modalManager = modalManager;

      // Lógica del modal de imagen
      let currentModalImages = [];
      let currentModalIndex = 0;
      let currentProjectTitle = '';
      
      const modal = document.getElementById('image-modal');
      const modalImage = document.getElementById('modal-image');
      const modalTitle = document.getElementById('modal-project-title');
      const modalIndicators = document.getElementById('modal-indicators');
      const closeModal = document.getElementById('close-modal');
      const modalPrev = document.getElementById('modal-prev');
      const modalNext = document.getElementById('modal-next');
      
      function openImageModal(imageSrc, imageAlt, projectImages, projectTitle, startIndex = 0) {
        console.log('openImageModal called:', { imageSrc, projectTitle, startIndex }); // Debug
        if (!modal || !modalImage) {
          console.error('Modal elements not found');
          return;
        }
        
        modalManager.openModal('image', () => {
          currentModalImages = projectImages;
          currentModalIndex = startIndex;
          currentProjectTitle = projectTitle;
          
          console.log('Setting up modal with images:', currentModalImages); // Debug
          
          updateModalContent();
          setupModalIndicators();
          
          modal.classList.remove('hidden');
          
          // Mostrar controles solo si hay más de una imagen
          if (currentModalImages.length > 1) {
            modalPrev?.classList.remove('hidden');
            modalNext?.classList.remove('hidden');
            modalIndicators?.classList.remove('hidden');
          } else {
            modalPrev?.classList.add('hidden');
            modalNext?.classList.add('hidden');
            modalIndicators?.classList.add('hidden');
          }
        });
      }
      
      function updateModalContent() {
        if (modalImage && modalTitle) {
          modalImage.src = currentModalImages[currentModalIndex];
          modalImage.alt = `${currentProjectTitle} - Imagen ${currentModalIndex + 1}`;
          modalTitle.textContent = currentProjectTitle;
        }
        
        // Actualizar indicadores
        const dots = modalIndicators?.querySelectorAll('.modal-dot');
        dots?.forEach((dot, index) => {
          dot.classList.toggle('active', index === currentModalIndex);
        });
      }
      
      function setupModalIndicators() {
        if (!modalIndicators || currentModalImages.length <= 1) return;
        
        modalIndicators.innerHTML = '';
        currentModalImages.forEach((_, index) => {
          const dot = document.createElement('button');
          dot.className = `modal-dot w-3 h-3 rounded-full bg-white/40 hover:bg-white/60 transition-colors ${
            index === currentModalIndex ? 'active bg-white' : ''
          }`;
          
          dot.addEventListener('click', () => {
            currentModalIndex = index;
            updateModalContent();
          });
          
          modalIndicators.appendChild(dot);
        });
      }
      
      function closeImageModal() {
        if (modal) {
          modal.classList.add('hidden');
          modalPrev?.classList.add('hidden');
          modalNext?.classList.add('hidden');
          modalIndicators?.classList.add('hidden');
          
          // Limpiar variables
          currentModalImages = [];
          currentModalIndex = 0;
          currentProjectTitle = '';
        }
      }
      
      function goToModalNext() {
        if (currentModalImages.length > 1) {
          currentModalIndex = (currentModalIndex + 1) % currentModalImages.length;
          updateModalContent();
        }
      }
      
      function goToModalPrev() {
        if (currentModalImages.length > 1) {
          currentModalIndex = (currentModalIndex - 1 + currentModalImages.length) % currentModalImages.length;
          updateModalContent();
        }
      }
      
      // Registrar el modal de imagen en el gestor
      modalManager.registerModal('image', closeImageModal);
      
      // Event listeners para el modal de imagen
      closeModal?.addEventListener('click', (e) => {
        e.stopPropagation();
        modalManager.closeActive();
      });
      
      modalPrev?.addEventListener('click', (e) => {
        e.stopPropagation();
        goToModalPrev();
      });
      
      modalNext?.addEventListener('click', (e) => {
        e.stopPropagation();
        goToModalNext();
      });
      
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) {
          modalManager.closeActive();
        }
      });
      
      // Event listeners para navegación con teclado (solo del modal de imagen)
      document.addEventListener('keydown', (e) => {
        if (modalManager.isActive('image')) {
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            goToModalPrev();
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            goToModalNext();
          }
        }
      });
      
      // Escuchar eventos custom de componentes hijos
      document.addEventListener('openImageModal', (e) => {
        const { imageSrc, imageAlt, projectImages, projectTitle, startIndex } = e.detail;
        openImageModal(imageSrc, imageAlt, projectImages, projectTitle, startIndex);
      });
      
      // Exponer funciones globalmente para compatibilidad
      window.openImageModal = openImageModal;
    </script>

    <style>
      html {
        scroll-behavior: smooth;
      }
      
      /* Estilos para el modal de imagen */
      #image-modal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.9) !important;
        backdrop-filter: blur(4px) !important;
        z-index: 9999 !important;
        align-items: center !important;
        justify-content: center !important;
        flex-direction: column !important;
      }
      
      #image-modal:not(.hidden) {
        display: flex !important;
      }
      
      #image-modal.hidden {
        display: none !important;
      }
      
      .modal-dot.active {
        background-color: #ffffff !important;
      }
      
      #modal-image {
        max-width: 100%;
        max-height: 70vh;
        object-fit: contain;
      }
    </style>
  </body>
</html>
