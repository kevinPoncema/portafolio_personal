---
// Archivo: src/components/ImageCarrusel.astro
export interface Props {
  imagenes: string[];
  altText: string;
}

const { imagenes, altText } = Astro.props;
---

<div class="image-carousel-container relative">
  <div class="carousel-wrapper relative overflow-hidden rounded-md">
    <div class="carousel-images flex transition-transform duration-300 ease-in-out">
      {imagenes.map((imagen, index) => (
        <div class="carousel-slide w-full flex-shrink-0" key={index}>
          <img 
            src={imagen} 
            alt={`${altText} - Imagen ${index + 1}`} 
            class="w-full h-48 object-cover cursor-pointer hover:opacity-90 transition-opacity duration-200"
            loading="lazy"
            data-modal-img={imagen}
            data-modal-alt={`${altText} - Imagen ${index + 1}`}
          />
        </div>
      ))}
    </div>
    
    <!-- Controles de navegación -->
    {imagenes.length > 1 && (
      <>
        <button 
          class="carousel-btn carousel-btn-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-white/80 hover:bg-white/90 p-2 rounded-full shadow-md transition-opacity duration-200"
          aria-label="Imagen anterior"
        >
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        
        <button 
          class="carousel-btn carousel-btn-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-white/80 hover:bg-white/90 p-2 rounded-full shadow-md transition-opacity duration-200"
          aria-label="Imagen siguiente"
        >
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </>
    )}
  </div>
  
  <!-- Indicadores -->
  {imagenes.length > 1 && (
    <div class="carousel-indicators flex justify-center space-x-2 mt-3">
      {imagenes.map((_, index) => (
        <button 
          class="indicator-dot w-2 h-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors duration-200"
          data-index={index}
          aria-label={`Ir a imagen ${index + 1}`}
          key={index}
        />
      ))}
    </div>
  )}
</div>

<!-- Modal de imagen ampliada -->
<div id="image-modal" class="modal-overlay fixed inset-0 z-[9999] hidden bg-black/90">
  <div class="modal-content flex flex-col items-center justify-center min-h-screen p-4">
    <!-- Header del modal con título y botón cerrar -->
    <div class="modal-header flex justify-between items-center w-full max-w-4xl mb-4">
      <h3 id="modal-project-title" class="text-white text-xl font-bold"></h3>
      <button 
        id="close-modal"
        class="bg-white/20 hover:bg-white/30 text-white rounded-full p-3 transition-colors duration-200 backdrop-blur-sm"
        aria-label="Cerrar modal"
      >
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Contenedor de imagen con carrusel -->
    <div class="modal-image-container relative max-w-4xl max-h-[70vh] w-full">
      <!-- Imagen principal -->
      <img 
        id="modal-image"
        src=""
        alt=""
        class="w-full h-full object-contain rounded-lg shadow-2xl bg-white/5 backdrop-blur-sm"
      />
      
      <!-- Controles del carrusel en modal -->
      <button 
        id="modal-prev"
        class="modal-nav-btn absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all duration-200 hidden backdrop-blur-sm"
        aria-label="Imagen anterior"
      >
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      
      <button 
        id="modal-next"
        class="modal-nav-btn absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/30 text-white p-3 rounded-full transition-all duration-200 hidden backdrop-blur-sm"
        aria-label="Imagen siguiente"
      >
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
    
    <!-- Indicadores del modal -->
    <div id="modal-indicators" class="flex justify-center space-x-2 mt-4 hidden">
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const carousels = document.querySelectorAll('.image-carousel-container');
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    const modalTitle = document.getElementById('modal-project-title');
    const modalIndicators = document.getElementById('modal-indicators');
    const closeModal = document.getElementById('close-modal');
    const modalPrev = document.getElementById('modal-prev');
    const modalNext = document.getElementById('modal-next');
    
    let currentModalImages = [];
    let currentModalIndex = 0;
    let currentProjectTitle = '';
    
    // Funcionalidad del modal
    function openModal(imageSrc, imageAlt, projectImages, projectTitle, startIndex = 0) {
      if (modal && modalImage) {
        currentModalImages = projectImages;
        currentModalIndex = startIndex;
        currentProjectTitle = projectTitle;
        
        updateModalContent();
        setupModalIndicators();
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Mostrar controles si hay más de una imagen
        if (currentModalImages.length > 1) {
          modalPrev?.classList.remove('hidden');
          modalNext?.classList.remove('hidden');
          modalIndicators?.classList.remove('hidden');
        }
        
        // Notificar que se abrió el modal de imagen
        window.dispatchEvent(new CustomEvent('imageModalOpened'));
      }
    }
    
    function updateModalContent() {
      if (modalImage && modalTitle) {
        modalImage.src = currentModalImages[currentModalIndex];
        modalImage.alt = `${currentProjectTitle} - Imagen ${currentModalIndex + 1}`;
        modalTitle.textContent = currentProjectTitle;
      }
      
      // Actualizar indicadores
      const dots = modalIndicators?.querySelectorAll('.modal-dot');
      dots?.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentModalIndex);
      });
    }
    
    function setupModalIndicators() {
      if (!modalIndicators || currentModalImages.length <= 1) return;
      
      modalIndicators.innerHTML = '';
      currentModalImages.forEach((_, index) => {
        const dot = document.createElement('button');
        dot.className = `modal-dot w-3 h-3 rounded-full bg-white/40 hover:bg-white/60 transition-colors duration-200 ${index === currentModalIndex ? 'active bg-white' : ''}`;
        dot.addEventListener('click', (e) => {
          e.stopPropagation();
          currentModalIndex = index;
          updateModalContent();
        });
        modalIndicators.appendChild(dot);
      });
    }
    
    function closeModalFunc() {
      if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
        modalPrev?.classList.add('hidden');
        modalNext?.classList.add('hidden');
        modalIndicators?.classList.add('hidden');
        
        // Notificar que se cerró el modal de imagen
        window.dispatchEvent(new CustomEvent('imageModalClosed'));
      }
    }
    
    function goToModalNext() {
      if (currentModalImages.length > 1) {
        currentModalIndex = (currentModalIndex + 1) % currentModalImages.length;
        updateModalContent();
      }
    }
    
    function goToModalPrev() {
      if (currentModalImages.length > 1) {
        currentModalIndex = (currentModalIndex - 1 + currentModalImages.length) % currentModalImages.length;
        updateModalContent();
      }
    }
    
    // Event listeners para el modal
    closeModal?.addEventListener('click', (e) => {
      e.stopPropagation();
      closeModalFunc();
    });
    
    modalPrev?.addEventListener('click', (e) => {
      e.stopPropagation();
      goToModalPrev();
    });
    
    modalNext?.addEventListener('click', (e) => {
      e.stopPropagation();
      goToModalNext();
    });
    
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModalFunc();
      }
    });
    
    // Event listener para evento personalizado
    window.addEventListener('openImageModal', (e) => {
      const { images, title, startIndex } = e.detail;
      openModal(images[startIndex], `${title} - Imagen ${startIndex + 1}`, images, title, startIndex);
    });
    
    // Cerrar modal con Escape y navegación con flechas
    document.addEventListener('keydown', (e) => {
      if (modal && !modal.classList.contains('hidden')) {
        if (e.key === 'Escape') {
          closeModalFunc();
        } else if (e.key === 'ArrowLeft') {
          goToModalPrev();
        } else if (e.key === 'ArrowRight') {
          goToModalNext();
        }
      }
    });
    
    carousels.forEach((carouselContainer) => {
      const images = carouselContainer.querySelector('.carousel-images');
      const prevBtn = carouselContainer.querySelector('.carousel-btn-prev');
      const nextBtn = carouselContainer.querySelector('.carousel-btn-next');
      const indicators = carouselContainer.querySelectorAll('.indicator-dot');
      const carouselImages = carouselContainer.querySelectorAll('img[data-modal-img]');
      
      if (!images) return;
      
      let currentIndex = 0;
      const totalImages = indicators.length;
      
      function updateCarousel() {
        const translateX = -currentIndex * 100;
        images.style.transform = `translateX(${translateX}%)`;
        
        // Actualizar indicadores
        indicators.forEach((indicator, index) => {
          indicator.classList.toggle('bg-blue-500', index === currentIndex);
          indicator.classList.toggle('bg-gray-300', index !== currentIndex);
        });
      }
      
      function goToNext() {
        currentIndex = (currentIndex + 1) % totalImages;
        updateCarousel();
      }
      
      function goToPrev() {
        currentIndex = (currentIndex - 1 + totalImages) % totalImages;
        updateCarousel();
      }
      
      function goToIndex(index) {
        currentIndex = index;
        updateCarousel();
      }
      
      // Event listeners para carrusel
      nextBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        goToNext();
      });
      
      prevBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        goToPrev();
      });
      
      indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', (e) => {
          e.stopPropagation();
          goToIndex(index);
        });
      });
      
      // Event listeners para modal
      carouselImages.forEach((img, imgIndex) => {
        img.addEventListener('click', (e) => {
          e.stopPropagation();
          
          const projectCard = img.closest('.project-card');
          const projectTitle = projectCard?.querySelector('h3')?.textContent || 'Proyecto';
          
          // Obtener todas las imágenes del proyecto
          const projectImages = Array.from(carouselImages).map(image => 
            image.getAttribute('data-modal-img')
          ).filter(Boolean);
          
          openModal(img.src, img.alt, projectImages, projectTitle, imgIndex);
        });
      });
      
      // Soporte para teclado en carrusel
      carouselContainer.addEventListener('keydown', (e) => {
        // Solo funciona si ningún modal está abierto
        if (modal?.classList.contains('hidden')) {
          if (e.key === 'ArrowLeft') {
            e.preventDefault();
            goToPrev();
          } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            goToNext();
          }
        }
      });
      
      // Inicializar
      updateCarousel();
    });
  });
</script>

<style>
  .image-carousel-container {
    width: 100%;
  }
  
  .carousel-wrapper {
    position: relative;
    width: 100%;
    height: 220px;
  }
  
  .carousel-images {
    display: flex;
    width: 100%;
    height: 100%;
  }
  
  .carousel-slide {
    min-width: 100%;
    height: 100%;
  }
  
  .carousel-slide img {
    height: 220px;
  }
  
  .carousel-btn {
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
    z-index: 10;
  }
  
  .carousel-wrapper:hover .carousel-btn {
    opacity: 1;
  }
  
  .indicator-dot.bg-blue-500 {
    background-color: #3b82f6;
  }
  
  .indicator-dot:hover {
    transform: scale(1.2);
  }
  
  .carousel-btn:active {
    transform: translateY(-50%) scale(0.95);
  }
  
  /* Estilos para el modal */
  .modal-overlay {
    backdrop-filter: blur(4px);
    z-index: 9999 !important;
  }
  
  .modal-content {
    animation: fadeIn 0.3s ease-out;
  }
  
  .modal-image-container {
    animation: scaleIn 0.3s ease-out;
  }
  
  .modal-nav-btn:hover {
    transform: translateY(-50%) scale(1.05);
  }
  
  .modal-dot.active {
    background-color: #ffffff !important;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
  
  @keyframes scaleIn {
    from {
      transform: scale(0.9);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  
  #modal-image {
    max-width: 100%;
    max-height: 70vh;
  }
</style>